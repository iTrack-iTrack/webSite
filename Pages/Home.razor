@page "/home"
@using SmartWatchWeb.Components
@inject Services.IHealthDataService HealthData
@inject Services.IBpmStreamService BpmStream

@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject Services.userState user

@implements IAsyncDisposable



<PageTitle>SmartWatch Overview</PageTitle>

<!-- Top navigation bar  -->
<div class="flex justify-between items-center px-6 py-4 bg-white shadow">
    <div class="text-xl font-bold text-gray-800">ITrack & IWatch</div>
    <a href="/account" class="profile-icon">
        <i class="fas fa-user"></i>
    </a>
</div>

<div class="p-6 space-y-6">
    <!-- Cards row -->
    <div class="flex w-full gap-4">
        <!-- BPM card -->
        <div class="data-card" style="flex-basis: 30%;">
            <div class="text-2xl font-semibold">Live BPM</div>
            <div class="text-4xl text-red-600 font-bold mt-2">
                @GetCurrentBpmDisplay()
            </div>
        </div>

        <!-- Steps card -->
        <div class="data-card" style="flex-basis: 30%;">
            <div class="text-2xl font-semibold">Steps</div>
            <div class="text-4xl text-blue-600 font-bold mt-2">@HealthData.Steps</div>
        </div>

        <!-- Oxygen card -->
        <div class="data-card" style="flex-basis: 40%;">
            <div class="text-2xl font-semibold">Oxidation level</div>
            <div class="text-4xl text-green-600 font-bold mt-2">@HealthData.Oxidation%</div>
            <canvas id="gaugeCanvas" width="300" height="150"></canvas>
        </div>
    </div>

    <!-- Charts grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- BPM Line Chart -->
        <div id="LineContainer">
            <BpmChart Config="_lineChartConfig" Data="HealthData.BpmHistory" />
        </div>

        <!-- Steps Bar Chart -->
        <div id="BarContainer">
            <StepsChart Config="_barChartConfig" Data="stepsData" />
        </div>
    </div>

    <!-- Date range selector -->
    <div class="flex items-center gap-4">
        <RadzenDropDown @bind-Value="selectedRange" Data="@ranges" Style="width: 200px;" />

        <button class="rounded-md shadow-md px-4 py-2 bg-white text-black font-semibold border border-gray-300
           transition-transform transition-shadow duration-200
           hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
            Load
        </button>
    </div>
    @if (selectedRange == "Custom range")
    {
        <div class="flex gap-4 mt-2">
            <RadzenDatePicker @bind-Value="startDate" DateFormat="yyyy-MM-dd" />
            <RadzenDatePicker @bind-Value="endDate" DateFormat="yyyy-MM-dd" />
        </div>
    }
</div>

@code {
    private List<TimePoint> stepsData = new()
    {
        new TimePoint(new DateTime(2025, 6, 1), 9800),
        new TimePoint(new DateTime(2025, 6, 2), 10200),
        new TimePoint(new DateTime(2025, 6, 3), 8700),
        new TimePoint(new DateTime(2025, 6, 4), 12000)
    };

    // UI State
    private List<string> ranges = new() { "Today", "Last 7 days", "Last 30 days", "Custom range" };
    private string selectedRange = "Today";
    private DateTime startDate = DateTime.Today;
    private DateTime endDate = DateTime.Today;

    // Chart Configs
    private LineConfig _lineChartConfig = Services.ChartService.CreateBpmLineConfig();
    private BarConfig _barChartConfig = Services.ChartService.CreateStepsBarConfig();

    // JS Interop
    private DotNetObjectReference<object>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) 
        {
            _objRef = DotNetObjectReference.Create<object>(this);
            await BpmStream.StartAsync(_objRef, user.userID);
            await JS.InvokeVoidAsync("createGauge", "gaugeCanvas", HealthData.Oxidation);
        }
    }
    private string GetCurrentBpmDisplay()
    {
        if (!HealthData.BpmHistory.Any())
            return "—";

        var last = HealthData.BpmHistory.Last();
        return last.Y.ToString();
    }

    [JSInvokable]
    public Task OnBpmReceived(string bpm)
    {
        HealthData.AddBpmDataPoint(int.Parse(bpm));
        StateHasChanged();
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        await BpmStream.StopAsync();
        _objRef?.Dispose();
    }
}